<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" width=device-width, initial-scale=1.0">
    <title>Funko Pop Scanner - OCR R√©el</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .stats {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            display: inline-block;
            margin-top: 10px;
        }

        .stats span {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        /* Scanner Section */
        .scanner-section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            display: block;
        }

        #canvas {
            display: none;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scan-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px dashed #ffd700;
            border-radius: 10px;
            background: rgba(255, 215, 0, 0.1);
        }

        .scan-zone::before {
            content: "üì¶ Place la bo√Æte ici";
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .scanner-controls {
            text-align: center;
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* OCR Results */
        .ocr-results {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .ocr-results h3 {
            margin-bottom: 10px;
            color: #ffd700;
        }

        .ocr-text {
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.6;
            color: rgba(255,255,255,0.8);
        }

        .detected-info {
            background: rgba(76, 175, 80, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #4caf50;
        }

        .detected-info strong {
            color: #4caf50;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Messages */
        .message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }

        .message.active {
            display: block;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.8);
            border-left: 5px solid #4caf50;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.8);
            border-left: 5px solid #f44336;
        }

        .message.warning {
            background: rgba(255, 152, 0, 0.8);
            border-left: 5px solid #ff9800;
        }

        /* Collection Grid */
        .collection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pop-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .pop-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.2);
        }

        .pop-card.locked {
            opacity: 0.6;
        }

        .pop-image-container {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
            position: relative;
            margin-bottom: 10px;
        }

        .pop-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: filter 0.5s ease;
        }

        .pop-card.locked .pop-image {
            filter: brightness(0) opacity(0.8);
        }

        .lock-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .pop-card.locked .lock-icon {
            opacity: 0.9;
        }

        .pop-number {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .pop-name {
            font-size: 0.9em;
            color: rgba(255,255,255,0.9);
        }

        .pop-card.locked .pop-name {
            color: rgba(255,255,255,0.5);
        }

        .rarity-border {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 15px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .pop-card:not(.locked) .rarity-border {
            opacity: 1;
        }

        .rarity-common { border: 3px solid #9e9e9e; }
        .rarity-rare { border: 3px solid #2196f3; box-shadow: 0 0 20px rgba(33, 150, 243, 0.5); }
        .rarity-legendary { border: 3px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.7); }

        /* Animation d√©blocage */
        @keyframes unlock {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes flash {
            0%, 100% { background: rgba(255,255,255,0.1); }
            50% { background: rgba(255,255,255,0.8); }
        }

        .pop-card.unlocking {
            animation: unlock 0.6s ease, flash 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .collection { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
            .scanner-controls { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∏ Funko Pop Scanner</h1>
            <p>Demon Slayer - OCR R√©el</p>
            <div class="stats">
                <span id="progress">0 / 0</span> d√©bloqu√©es
                (<span id="percentage">0%</span>)
            </div>
        </header>

        <!-- Scanner -->
        <div class="scanner-section">
            <h2 style="text-align: center; margin-bottom: 15px;">üéØ Scanner une bo√Æte</h2>
            
            <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="camera-overlay">
                    <div class="scan-zone"></div>
                </div>
            </div>

            <div class="scanner-controls">
                <button class="btn btn-primary" id="startCamera">üì∑ D√©marrer la cam√©ra</button>
                <button class="btn btn-primary" id="captureBtn" disabled>üì∏ Capturer & Analyser</button>
                <button class="btn btn-secondary" id="stopCamera" disabled>‚èπÔ∏è Arr√™ter</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>üîç Analyse OCR en cours...</p>
            </div>

            <div class="message" id="message"></div>

            <div class="ocr-results" id="ocrResults" style="display: none;">
                <h3>üìù Texte d√©tect√© :</h3>
                <div class="ocr-text" id="ocrText"></div>
                <div class="detected-info" id="detectedInfo"></div>
            </div>
        </div>

        <!-- Collection -->
        <h2 style="text-align: center; margin-bottom: 20px;">üé¥ Ma Collection</h2>
        <div class="collection" id="collection"></div>
    </div>

    <!-- Tesseract.js OCR Library -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <script>
        // ========================================
        // üìä BASE DE DONN√âES
        // ========================================
        const POPS_DATABASE = [
            { number: 1532, name: "TANJIRO KAMADO", series: "Demon Slayer", rarity: "common" },
            { number: 1533, name: "NEZUKO KAMADO", series: "Demon Slayer", rarity: "rare" },
            { number: 1534, name: "ZENITSU AGATSUMA", series: "Demon Slayer", rarity: "common" },
            { number: 1535, name: "INOSUKE HASHIBIRA", series: "Demon Slayer", rarity: "rare" },
            { number: 1536, name: "GIYU TOMIOKA", series: "Demon Slayer", rarity: "legendary" },
            { number: 1537, name: "SHINOBU KOCHO", series: "Demon Slayer", rarity: "rare" },
            { number: 1538, name: "KYOJURO RENGOKU", series: "Demon Slayer", rarity: "legendary" },
            { number: 1539, name: "TENGEN UZUI", series: "Demon Slayer", rarity: "rare" },
        ];

        // Variations de noms accept√©es (pour OCR impr√©cis)
        const NAME_VARIATIONS = {
            "TANJIRO": ["TANJIRO", "TANJIROU", "TANJIR0"],
            "NEZUKO": ["NEZUKO", "NEZUK0"],
            "ZENITSU": ["ZENITSU", "ZENITZU", "ZENITS"],
            "INOSUKE": ["INOSUKE", "INOSKE", "IN0SUKE"],
            "GIYU": ["GIYU", "GIYUU", "GIYO"],
            "SHINOBU": ["SHINOBU", "SHIN0BU"],
            "KYOJURO": ["KYOJURO", "KYOUJURO", "KYOJUR0"],
            "TENGEN": ["TENGEN", "TENG3N"]
        };

        // ========================================
        // üíæ PROGRESSION
        // ========================================
        let unlockedPops = JSON.parse(localStorage.getItem('unlockedPops') || '[]');

        // ========================================
        // üì∑ GESTION CAM√âRA
        // ========================================
        let stream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        document.getElementById('startCamera').onclick = async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Cam√©ra arri√®re
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = stream;
                
                document.getElementById('startCamera').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('stopCamera').disabled = false;
                
                showMessage('success', '‚úÖ Cam√©ra activ√©e ! Place la bo√Æte dans la zone jaune');
            } catch (err) {
                showMessage('error', '‚ùå Impossible d\'acc√©der √† la cam√©ra : ' + err.message);
            }
        };

        document.getElementById('stopCamera').onclick = () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                
                document.getElementById('startCamera').disabled = false;
                document.getElementById('captureBtn').disabled = true;
                document.getElementById('stopCamera').disabled = true;
                
                showMessage('warning', '‚èπÔ∏è Cam√©ra arr√™t√©e');
            }
        };

        // ========================================
        // üîç CAPTURE & OCR
        // ========================================
        document.getElementById('captureBtn').onclick = async () => {
            // Capture de l'image
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/png');
            
            // D√©sactiver le bouton pendant l'analyse
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('ocrResults').style.display = 'none';
            
            try {
                // OCR avec Tesseract
                const result = await Tesseract.recognize(imageData, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            console.log(`OCR: ${Math.round(m.progress * 100)}%`);
                        }
                    }
                });
                
                const detectedText = result.data.text;
                console.log('üìù Texte d√©tect√©:', detectedText);
                
                // Afficher le texte OCR
                document.getElementById('ocrText').textContent = detectedText || '(Aucun texte d√©tect√©)';
                document.getElementById('ocrResults').style.display = 'block';
                
                // Analyse du texte
                const validPop = analyzeScan(detectedText);
                
                if (validPop) {
                    attemptUnlock(validPop);
                } else {
                    showMessage('error', '‚ùå Aucune Funko Demon Slayer valide d√©tect√©e');
                    document.getElementById('detectedInfo').innerHTML = '<strong>‚ö†Ô∏è V√©rifications √©chou√©es</strong><br>Le num√©ro ET le nom doivent √™tre pr√©sents sur la bo√Æte.';
                }
                
            } catch (err) {
                console.error('Erreur OCR:', err);
                showMessage('error', '‚ùå Erreur lors de l\'analyse : ' + err.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('captureBtn').disabled = false;
            }
        };

        // ========================================
        // üß† ANALYSE DU SCAN
        // ========================================
        function analyzeScan(text) {
            const upperText = text.toUpperCase();
            
            // Nettoyer le texte (garder lettres, chiffres, espaces)
            const cleanText = upperText.replace(/[^A-Z0-9\s]/g, ' ');
            
            console.log('üîç Analyse:', cleanText);
            
            // Chercher un num√©ro valide
            const numbers = cleanText.match(/\b\d{3,4}\b/g) || [];
            console.log('üî¢ Num√©ros trouv√©s:', numbers);
            
            for (let numStr of numbers) {
                const number = parseInt(numStr);
                const pop = POPS_DATABASE.find(p => p.number === number);
                
                if (pop) {
                    console.log(`‚úÖ Num√©ro #${number} trouv√© dans la DB`);
                    
                    // V√©rifier que le nom du personnage est pr√©sent
                    const nameFound = checkNameInText(pop.name, cleanText);
                    
                    if (nameFound) {
                        console.log(`‚úÖ Nom "${pop.name}" valid√© !`);
                        
                        document.getElementById('detectedInfo').innerHTML = `
                            <strong>‚úÖ Funko d√©tect√©e :</strong><br>
                            üì¶ Num√©ro : #${pop.number}<br>
                            üë§ Nom : ${pop.name}<br>
                            üéØ Validation : NUM√âRO + NOM confirm√©s
                        `;
                        
                        return pop;
                    } else {
                        console.log(`‚ùå Nom "${pop.name}" non trouv√© dans le texte`);
                        document.getElementById('detectedInfo').innerHTML = `
                            <strong style="color: #ff9800;">‚ö†Ô∏è Validation partielle :</strong><br>
                            üì¶ Num√©ro #${number} d√©tect√©<br>
                            ‚ùå Nom "${pop.name}" non trouv√©<br>
                            üí° Assure-toi que le nom est visible
                        `;
                    }
                }
            }
            
            return null;
        }

        // ========================================
        // ‚úÖ V√âRIFICATION DU NOM
        // ========================================
        function checkNameInText(popName, text) {
            // Diviser le nom en mots (ex: "TANJIRO KAMADO" -> ["TANJIRO", "KAMADO"])
            const nameWords = popName.split(' ');
            
            for (let word of nameWords) {
                // Chercher le mot ou ses variations
                const variations = NAME_VARIATIONS[word] || [word];
                
                let wordFound = false;
                for (let variant of variations) {
                    if (text.includes(variant)) {
                        console.log(`  ‚úì "${variant}" trouv√©`);
                        wordFound = true;
                        break;
                    }
                }
                
                // Si au moins un mot cl√© du nom est trouv√©, OK
                if (wordFound) {
                    return true;
                }
            }
            
            return false;
        }

        // ========================================
        // üîì D√âBLOCAGE
        // ========================================
        function attemptUnlock(pop) {
            if (unlockedPops.includes(pop.number)) {
                showMessage('warning', `üîÅ ${pop.name} est d√©j√† dans ta collection !`);
                return;
            }
            
            // D√âBLOCAGE
            unlockedPops.push(pop.number);
            localStorage.setItem('unlockedPops', JSON.stringify(unlockedPops));
            
            // Animation
            const cards = document.querySelectorAll('.pop-card');
            const index = POPS_DATABASE.findIndex(p => p.number === pop.number);
            const card = cards[index];
            
            card.classList.add('unlocking');
            setTimeout(() => {
                card.classList.remove('locked', 'unlocking');
                updateStats();
            }, 600);
            
            const rarityEmoji = {
                'common': '‚ö™',
                'rare': 'üîµ',
                'legendary': 'üü°'
            };
            showMessage('success', `${rarityEmoji[pop.rarity]} ${pop.name} #${pop.number} d√©bloqu√©(e) !`);
        }

        // ========================================
        // üí¨ MESSAGES
        // ========================================
        function showMessage(type, text) {
            const message = document.getElementById('message');
            message.className = `message active ${type}`;
            message.textContent = text;
            
            setTimeout(() => {
                message.classList.remove('active');
            }, 5000);
        }

        // ========================================
        // üé® RENDU COLLECTION
        // ========================================
        function renderCollection() {
            const container = document.getElementById('collection');
            container.innerHTML = '';

            POPS_DATABASE.forEach(pop => {
                const isUnlocked = unlockedPops.includes(pop.number);
                
                const card = document.createElement('div');
                card.className = `pop-card ${isUnlocked ? '' : 'locked'}`;

                card.innerHTML = `
                    <div class="pop-image-container">
                        <img class="pop-image" src="${pop.number}.png" alt="${pop.name}" 
                             onerror="this.src='https://via.placeholder.com/150?text=${pop.number}'">
                        <div class="lock-icon">üîí</div>
                    </div>
                    <div class="pop-number">#${pop.number}</div>
                    <div class="pop-name">${isUnlocked ? pop.name : '???'}</div>
                    <div class="rarity-border rarity-${pop.rarity}"></div>
                `;

                container.appendChild(card);
            });

            updateStats();
        }

        function updateStats() {
            const total = POPS_DATABASE.length;
            const unlocked = unlockedPops.length;
            const percentage = Math.round((unlocked / total) * 100);

            document.getElementById('progress').textContent = `${unlocked} / ${total}`;
            document.getElementById('percentage').textContent = `${percentage}%`;
        }

        // ========================================
        // üöÄ INIT
        // ========================================
        renderCollection();
        
        console.log('üéÆ Scanner Funko Pop charg√© !');
        console.log('üìù Pour reset: localStorage.clear() + F5');
    </script>
</body>
</html>
