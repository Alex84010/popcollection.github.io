<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Collection Funko Pop</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .screen {
            display: none;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .screen.active {
            display: block;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        /* Zone de scan */
        .camera-zone {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 60px 20px;
            text-align: center;
            margin: 20px 0;
        }

        #photo-input {
            display: none;
        }

        .scan-button {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.3em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .scan-button:hover {
            transform: scale(1.05);
        }

        .scan-button.scanning {
            background: #FFA726;
            pointer-events: none;
        }

        /* Preview de l'image */
        .preview-zone {
            margin: 20px 0;
            text-align: center;
        }

        .preview-zone img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        /* Stats */
        .stats {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
        }

        /* Grille de collection */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .pop-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .pop-card:hover {
            transform: translateY(-5px);
        }

        .pop-card img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            transition: filter 0.5s;
        }

        /* Silhouette noire */
        .pop-card.locked img {
            filter: brightness(0);
        }

        .pop-card p {
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Boutons de navigation */
        .nav-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Pop-ups */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup.hidden {
            display: none;
        }

        .popup-content {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            text-align: center;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .popup-content img {
            max-width: 200px;
            margin: 20px 0;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .popup-content button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Animation de d√©blocage */
        .celebrate {
            animation: popIn 0.5s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .message.error {
            background: #f44336;
            color: white;
        }

        .message.success {
            background: #4CAF50;
            color: white;
        }

        .message.info {
            background: #2196F3;
            color: white;
        }

        /* Debug info */
        .debug-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.85em;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-info pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .detected-info {
            background: rgba(33, 150, 243, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- √âcran de scan -->
    <div id="scan-screen" class="screen active">
        <h1>üì∏ Scanner une Pop</h1>
        <div class="camera-zone">
            <input type="file" id="photo-input" accept="image/*" capture="environment">
            <label for="photo-input" class="scan-button" id="scan-btn">
                üì∑ Prendre une photo
            </label>
        </div>
        <div id="preview-zone" class="preview-zone"></div>
        <div id="scan-message"></div>
        <button onclick="showCollection()" class="nav-button">
            Voir ma collection
        </button>
    </div>

    <!-- √âcran de collection -->
    <div id="collection-screen" class="screen">
        <h1>üé¥ Ma Collection</h1>
        <div class="stats">
            <span id="stats-text">0/0 d√©bloqu√©es</span>
        </div>
        
        <div id="grid" class="grid">
            <!-- Les cartes vont appara√Ætre ici -->
        </div>
        
        <button onclick="showScan()" class="nav-button">
            Retour au scan
        </button>
    </div>

    <!-- Pop-up d√©tail -->
    <div id="detail-popup" class="popup hidden">
        <div class="popup-content">
            <button onclick="closeDetail()" class="close-btn">‚úñ</button>
            <img id="detail-image" src="" alt="">
            <h2 id="detail-name">???</h2>
            <p id="detail-number">#???</p>
        </div>
    </div>

    <!-- Pop-up d√©blocage -->
    <div id="unlock-popup" class="popup hidden">
        <div class="popup-content celebrate">
            <h2>üéâ NOUVELLE POP !</h2>
            <img id="unlock-image" src="" alt="">
            <h3 id="unlock-name"></h3>
            <p id="unlock-number"></p>
            <button onclick="closeUnlock()">Super !</button>
        </div>
    </div>

    <script>
        // ========== DONN√âES ==========
        
        // Liste de toutes les Pops (AJOUTE TOUTES TES POPS ICI)
        const allPops = [
            // Demon Slayer
            { number: 867, name: "Inosuke Hashibira", series: "Demon Slayer" },
            { number: 1532, name: "Inosuke Hashibira", series: "Demon Slayer" },
            { number: 615, name: "Tanjiro Kamado", series: "Demon Slayer" },
            { number: 616, name: "Nezuko Kamado", series: "Demon Slayer" },
            { number: 868, name: "Zenitsu Agatsuma", series: "Demon Slayer" },
            { number: 869, name: "Giyu Tomioka", series: "Demon Slayer" },
            { number: 870, name: "Shinobu Kocho", series: "Demon Slayer" },
            { number: 871, name: "Kyojuro Rengoku", series: "Demon Slayer" },
            { number: 1559, name: "Muzan Kibutsuji", series: "Demon Slayer" },
            
            // Dragon Ball Z
            { number: 952, name: "Kami", series: "Dragon Ball Z" },
            
            // AJOUTE TES AUTRES POPS ICI
        ];

        // Pops d√©bloqu√©es (sauvegard√©es dans le navigateur)
        let unlockedPops = JSON.parse(localStorage.getItem('unlockedPops')) || [];

        // ========== FONCTIONS PRINCIPALES ==========

        function showScan() {
            document.getElementById('scan-screen').classList.add('active');
            document.getElementById('collection-screen').classList.remove('active');
            document.getElementById('preview-zone').innerHTML = '';
            document.getElementById('scan-message').innerHTML = '';
        }

        function showCollection() {
            document.getElementById('scan-screen').classList.remove('active');
            document.getElementById('collection-screen').classList.add('active');
            displayCollection();
        }

        function displayCollection() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            const sorted = [...allPops].sort((a, b) => a.number - b.number);

            sorted.forEach(pop => {
                const isUnlocked = unlockedPops.includes(pop.number);
                
                const card = document.createElement('div');
                card.className = isUnlocked ? 'pop-card' : 'pop-card locked';
                card.onclick = () => showDetail(pop, isUnlocked);
                
                card.innerHTML = `
                    <img src="${pop.number}.png" alt="Pop ${pop.number}">
                    <p>${isUnlocked ? pop.name : '???'}</p>
                    <p>#${pop.number}</p>
                `;
                
                grid.appendChild(card);
            });

            updateStats();
        }

        function updateStats() {
            const total = allPops.length;
            const unlocked = unlockedPops.length;
            const percent = Math.round((unlocked / total) * 100);
            
            document.getElementById('stats-text').textContent = 
                `${unlocked}/${total} d√©bloqu√©es (${percent}%)`;
        }

        function showDetail(pop, isUnlocked) {
            const popup = document.getElementById('detail-popup');
            const img = document.getElementById('detail-image');
            const name = document.getElementById('detail-name');
            const number = document.getElementById('detail-number');

            img.src = `${pop.number}.png`;
            
            if (isUnlocked) {
                img.style.filter = 'none';
                name.textContent = pop.name;
            } else {
                img.style.filter = 'brightness(0)';
                name.textContent = '???';
            }
            
            number.textContent = `#${pop.number}`;
            popup.classList.remove('hidden');
        }

        function closeDetail() {
            document.getElementById('detail-popup').classList.add('hidden');
        }

        // ========== SCAN OCR AM√âLIOR√â ==========

        document.getElementById('photo-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const scanBtn = document.getElementById('scan-btn');
            const messageDiv = document.getElementById('scan-message');
            const previewZone = document.getElementById('preview-zone');

            // Afficher la preview
            const reader = new FileReader();
            reader.onload = (event) => {
                previewZone.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);

            scanBtn.classList.add('scanning');
            scanBtn.textContent = '‚è≥ Analyse en cours...';
            messageDiv.innerHTML = '<p class="message info">üîç Recherche du nom et du num√©ro...</p>';

            try {
                const result = await Tesseract.recognize(file, 'eng', {
                    logger: (m) => {
                        if (m.status === 'recognizing text') {
                            const percent = Math.round(m.progress * 100);
                            messageDiv.innerHTML = `<p class="message info">üîç Analyse : ${percent}%</p>`;
                        }
                    }
                });

                const detectedText = result.data.text;
                console.log('Texte brut:', detectedText);

                // Analyser le texte avec la nouvelle m√©thode
                const scanResult = analyzeTextImproved(detectedText);
                
                const debugInfo = `
                    <div class="debug-info">
                        <strong>Texte d√©tect√© :</strong>
                        <pre>${detectedText}</pre>
                    </div>
                `;

                if (scanResult.success) {
                    const detectedInfo = `
                        <div class="detected-info">
                            <strong>‚úÖ Trouv√© :</strong><br>
                            Nom: ${scanResult.pop.name}<br>
                            Num√©ro: #${scanResult.pop.number}<br>
                            S√©rie: ${scanResult.pop.series}
                        </div>
                    `;
                    messageDiv.innerHTML = debugInfo + detectedInfo;
                    handleScan(scanResult.pop);
                } else {
                    messageDiv.innerHTML = debugInfo + 
                        `<p class="message error">${scanResult.error}</p>`;
                }

            } catch (error) {
                console.error('Erreur OCR:', error);
                messageDiv.innerHTML = `<p class="message error">‚ùå Erreur lors du scan</p>`;
            }

            scanBtn.classList.remove('scanning');
            scanBtn.textContent = 'üì∑ Prendre une photo';
            e.target.value = '';
        });

        // ========== ANALYSE AM√âLIOR√âE ==========

        function analyzeTextImproved(text) {
            text = text.toUpperCase();
            console.log('Texte nettoy√©:', text);

            // Extraire TOUS les nombres (m√™me avec des erreurs OCR)
            const allNumbers = extractAllNumbers(text);
            console.log('Tous les nombres trouv√©s:', allNumbers);

            if (allNumbers.length === 0) {
                return {
                    success: false,
                    error: "‚ùå Aucun num√©ro d√©tect√©"
                };
            }

            // Chercher chaque nombre dans notre base
            for (let num of allNumbers) {
                const pop = allPops.find(p => p.number === num);
                
                if (!pop) continue;

                // V√©rifier si le nom est pr√©sent
                const nameFound = checkNameInText(pop.name, text);
                
                console.log(`#${num} - ${pop.name}: ${nameFound ? 'TROUV√â ‚úÖ' : 'pas trouv√© ‚ùå'}`);

                if (nameFound) {
                    return {
                        success: true,
                        pop: pop
                    };
                }
            }

            // Pas de match nom + num√©ro
            return {
                success: false,
                error: `‚ùå Num√©ros d√©tect√©s: ${allNumbers.join(', ')}<br>Mais aucun nom ne correspond`
            };
        }

        // Extraire tous les nombres possibles (m√™me mal d√©tect√©s)
        function extractAllNumbers(text) {
            const numbers = new Set();
            
            // M√©thode 1: Nombres de 3-4 chiffres isol√©s
            const matches1 = text.match(/\b\d{3,4}\b/g);
            if (matches1) {
                matches1.forEach(m => numbers.add(parseInt(m)));
            }

            // M√©thode 2: Chercher des nombres avec espaces "15 32" ‚Üí 1532
            const matches2 = text.match(/\b(\d{1,2})\s+(\d{1,2})\b/g);
            if (matches2) {
                matches2.forEach(m => {
                    const combined = m.replace(/\s/g, '');
                    const num = parseInt(combined);
                    if (num >= 100 && num <= 9999) {
                        numbers.add(num);
                    }
                });
            }

            // M√©thode 3: Corriger les erreurs OCR courantes
            let cleaned = text
                .replace(/O/g, '0')
                .replace(/I/g, '1')
                .replace(/L/g, '1')
                .replace(/S/g, '5')
                .replace(/B/g, '8')
                .replace(/Z/g, '2');
            
            const matches3 = cleaned.match(/\b\d{3,4}\b/g);
            if (matches3) {
                matches3.forEach(m => numbers.add(parseInt(m)));
            }

            return Array.from(numbers).sort((a, b) => a - b);
        }

        // V√©rifier si le nom est dans le texte
        function checkNameInText(popName, text) {
            const variations = getNameVariations(popName);
            
            for (let variation of variations) {
                if (text.includes(variation.toUpperCase())) {
                    console.log(`Match trouv√©: "${variation}"`);
                    return true;
                }
            }
            
            return false;
        }

        function getNameVariations(name) {
            const variations = [];
            
            // Nom complet
            variations.push(name);
            
            // Pr√©nom seul
            const parts = name.split(' ');
            if (parts.length > 1) {
                variations.push(parts[0]); // Pr√©nom
                variations.push(parts[parts.length - 1]); // Nom de famille
            }
            
            // Sans espaces
            variations.push(name.replace(/\s/g, ''));
            
            // Sans accents
            variations.push(name.normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
            
            // Variations avec tirets/espaces
            variations.push(name.replace(/\s/g, '-'));
            variations.push(name.replace(/-/g, ' '));
            
            return variations;
        }

        // ========== GESTION DU SCAN ==========
function handleScan(pop) {
            if (unlockedPops.includes(pop.number)) {
                const messageDiv = document.getElementById('scan-message');
                messageDiv.innerHTML += `<p class="message error">‚ö†Ô∏è Cette Pop est d√©j√† dans ta collection !</p>`;
                return;
            }

            unlockedPops.push(pop.number);
            saveProgress();
            
            setTimeout(() => {
                showUnlock(pop);
            }, 1000);
        }

        function showUnlock(pop) {
            const popup = document.getElementById('unlock-popup');
            document.getElementById('unlock-image').src = `${pop.number}.png`;
            document.getElementById('unlock-name').textContent = pop.name;
            document.getElementById('unlock-number').textContent = `#${pop.number}`;
            
            popup.classList.remove('hidden');
        }

        function closeUnlock() {
            document.getElementById('unlock-popup').classList.add('hidden');
            showCollection();
        }

        // ========== SAUVEGARDE ==========

        function saveProgress() {
            localStorage.setItem('unlockedPops', JSON.stringify(unlockedPops));
        }

        // ========== INITIALISATION ==========
        displayCollection();
    </script>
</body>
</html>
        
