<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Funko Scan</title>

<style>
body {
  margin: 0;
  background: #0f0f0f;
  color: white;
  font-family: Arial, sans-serif;
}

video {
  width: 100%;
  max-height: 40vh;
  object-fit: cover;
}

button {
  width: 100%;
  padding: 14px;
  font-size: 18px;
  background: #ff4757;
  color: white;
  border: none;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
  padding: 12px;
}

.card img {
  width: 100%;
}

.locked img {
  filter: brightness(0);
}
</style>
</head>

<body>

<h2 style="text-align:center">Scanner une Funko Pop</h2>

<video id="video" autoplay playsinline></video>
<button onclick="scan()">ðŸ“¸ Scanner</button>

<canvas id="canvas" hidden></canvas>

<div id="collection" class="grid"></div>

<script>
/* DATA */
const pops = [615, 616, 617, 618];
let unlocked = JSON.parse(localStorage.getItem("unlocked")) || [];

/* CAMERA */
const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
  .then(stream => video.srcObject = stream);

/* SCAN */
async function scan() {
  const canvas = document.getElementById("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  canvas.getContext("2d").drawImage(video, 0, 0);
  const blob = await new Promise(r => canvas.toBlob(r, "image/jpeg"));

  const form = new FormData();
  form.append("image", blob);

  const res = await fetch("http://localhost:3000/verify", {
    method: "POST",
    body: form
  });

  const result = await res.json();

  if (
    result.is_funko_box &&
    result.license === "demon_slayer" &&
    pops.includes(result.detected_number) &&
    result.confidence > 0.7 &&
    !unlocked.includes(result.detected_number)
  ) {
    unlocked.push(result.detected_number);
    localStorage.setItem("unlocked", JSON.stringify(unlocked));
    render();
    alert("ðŸŽ‰ DÃ©bloquÃ©e !");
  } else {
    alert("âŒ Scan invalide");
  }
}

/* COLLECTION */
function render() {
  const grid = document.getElementById("collection");
  grid.innerHTML = "";

  pops.forEach(n => {
    const card = document.createElement("div");
    card.className = "card";
    if (!unlocked.includes(n)) card.classList.add("locked");

    const img = document.createElement("img");
    img.src = `${n}.png`;

    card.appendChild(img);
    grid.appendChild(card);
  });
}

render();
</script>

</body>
</html>
